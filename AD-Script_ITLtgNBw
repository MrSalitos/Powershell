<# Powershell-Script zum Erstellen einer OU-Struktur, Benutzern und Gruppen. Erstellt Gruppen gem. AGDLP und 
setzt direkt die Mitgliedschaften. Weiterhin werden auf einer Netzwerkfreigabe Ordner für jede Abteilung erstellt 
und die NTFS-Berechtigungen angepasst. #>

$kdrGrp = "Kdr"
$abteilungen = @("S1","S2","S3","S4","S6")
$kdrPos = @("Kdr","stvKdr","VorZi")
$abtPos = @("AbtLtr","AbtFw","GeZi")
$ntfsRechte = @("AE","S","L")
$sharePath = '\\DC-01\share\'
$DC = "DC=BUNDESWEHR,DC=INTERN"
$verband = "VersBtl131"
$einheit = "Stab"
$path = $DC
New-ADOrganizationalUnit -Name $verband -Path $path -ProtectedFromAccidentalDeletion $false
$verband = "OU=" + $verband + "," + $path
New-ADOrganizationalUnit -Name $einheit -Path $verband -ProtectedFromAccidentalDeletion $false
$einheit = "OU=" + $einheit + "," + $verband
New-ADOrganizationalUnit -Name "G_Gruppen" -Path $verband -ProtectedFromAccidentalDeletion $false
    $g_groupPath = "OU=G_Gruppen," + $verband
New-ADOrganizationalUnit -Name "DL_Gruppen" -Path $verband -ProtectedFromAccidentalDeletion $false
    $dl_groupPath = "OU=DL_Gruppen," + $verband

foreach($abt IN $abteilungen){
    New-ADOrganizationalUnit -Name $abt -Path $einheit -ProtectedFromAccidentalDeletion $false

    $userName = "dummyUser"
    $userPath = "OU=" + $abt + "," + $einheit
    $userPassword = "P@ssw0rd01"
    
    # Domänenlokale Gruppen anlegen
    foreach($ntfsRecht IN $ntfsRechte){
        $dl_groupName = "DL_" + $abt + "_" + $ntfsRecht
            New-ADGroup -Name $dl_groupName -Path $dl_groupPath -GroupScope DomainLocal
            #echo "Name: $dl_groupName, Pfad: $dl_groupPath"
    }
       
        
    # Globale Gruppen anlegen
        echo ""
        echo "globale Gruppen werden Mitglieder domänenlokaler Gruppen"
        echo "--------------------------------------------------------------------------------------------"
    foreach($pos IN $abtPos){
        $g_groupName = "G_" + $abt + "_" + $pos
           New-ADGroup -Name $g_groupName -Path $g_groupPath -GroupScope Global
           #echo "Name: $g_groupName, Pfad: $g_groupPath"
        $g_groupFqdn = "CN=" + $g_groupName + "," + $g_groupPath
        
        $identity = switch ($pos){
            "AbtLtr" {"DL_" + $abt + "_AE"}
            "AbtFw" {"DL_" + $abt + "_S"}
            "GeZi" {"DL_" + $abt + "_L"}
        }
        echo "$g_groupFqdn wird Mitglied von $identity"
        
        Add-ADGroupMember -Identity $identity -Members $g_groupFqdn
        }

    
    # Benutzerkonten anlegen
        echo ""
        echo "Benutzer werden Mitglieder globaler Gruppen"
        echo "--------------------------------------------------------------------------------------------"
    foreach($pos IN $abtPos){
        $userName = $abt + "_" + $pos
        $userGlobalGroup = "G_" + $abt + "_" + $pos
        $userFqdn = "CN=" + $userName + "," + $userPath
        New-ADUser -SamAccountName $userName -Name $userName -UserPrincipalName $userName -Enabled $true -AccountPassword (ConvertTo-SecureString -AsPlainText $userPassword -Force) -PasswordNeverExpires $true -Path $userPath
        Add-ADGroupMember -Identity $userGlobalGroup -Members $userFqdn
        echo "$userFqdn wird Mitglied der Gruppe $userGlobalGroup "
    }

    foreach($share IN $abt){
        $shareName = $sharePath + '\' + $abt
        $testPath = Test-Path -Path $shareName
        if($testPath -eq $false){
            New-Item -Path $shareName -ItemType directory

            $dlAE = "DL_" + $share + "_AE"
            echo $dlAE
            $dlS = "DL_" + $share + "_S"
            echo $dlS
            $dlL = "DL_" + $share + "_L"
            echo $dlL

            # ACL holen
            $acl = Get-Acl $shareName

            # Vererbung deaktivieren
            $acl.SetAccessRuleProtection($true,$false)

            # Alle Berechtigungen entfernen
            foreach($access IN $acl.Access){
                $acl.RemoveAccessRule($access)
            }
            
        ## Berechtigungen setzen ##
        New-Object System.Security.AccessControl.FileSystemAccessRule("$dlL","ReadandExecute","ContainerInherit","InheritOnly","Allow") | %{$acl.SetAccessRule($_)}
        New-Object System.Security.AccessControl.FileSystemAccessRule("$dlS","Write","ContainerInherit","InheritOnly","Allow") | %{$acl.SetAccessRule($_)}
        New-Object System.Security.AccessControl.FileSystemAccessRule("$dlAE","Modify","ContainerInherit","InheritOnly","Allow") | %{$acl.SetAccessRule($_)}
        
         # ACL setzen
        Set-Acl $shareName $acl
        }

    }
}
